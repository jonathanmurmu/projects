#!/usr/bin/python
import smtplib
import MySQLdb
import cgi, cgitb 
# Create instance of FieldStorage 
form = cgi.FieldStorage() 

db = MySQLdb.connect("localhost","user1","mindfire","assignment")

# setup a cursor object using cursor() method
cursor = db.cursor()
to=form.getvalue('email')
# to = 'jonathan.murmu@mindfiresolutions.com'
sender = 'jonathan.murmu@mindfiresolutions.com'
sender_password = 'jono0077'

subject = 'Password Recovery Email'
username =''
password =''

print "Content-type:text/html\r\n\r\n"
print
print '<html>'
print '<head>'
print '<title>Hello Word - First CGI Program</title>'
print '</head>'
print '<body>'
print '<h2>Hello Word! This is my first CGI program</h2>'

cursor.execute("SELECT username,password FROM user_detail where email='{0}'".format(to))
try:
	for row in cursor.fetchall():
		username = row[0]
		password = row[1]
		# print "<br>Username and password is sent to your email address"
except:
	print "<br>error"
text = """username = {0} \r\n 
password = {1}""".format(username,password)
# sender='sumit.choudhary@mindfiresolutions.com'

# sender_password = '9835945321'

server = smtplib.SMTP('email.mindfiresolutions.com',587)
server.ehlo()
server.starttls()
server.login(sender,sender_password)

body = '\r\n'.join([
		'To: {0}'.format(to),
		'From: {0}'.format(sender),
		'Subject: {0}'.format(subject), 
		'',
		text
		])

try:
	server.sendmail(sender,[to],body)
	print '<br>Username and password is sent to your email address'
except:
	print '<br>error sending email'

server.quit()